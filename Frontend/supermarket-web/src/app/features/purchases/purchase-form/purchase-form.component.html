<p-toast></p-toast>

<p-card>
  <ng-template pTemplate="header">
    <div class="form-header">
      <h2>{{ isEditMode ? "Chỉnh sửa phiếu nhập" : "Tạo phiếu nhập mới" }}</h2>
    </div>
  </ng-template>

  @if (error) {
    <p-message severity="error" [text]="error" class="mb-3"></p-message>
  }

  @if (loading) {
    <div class="loading-container">
      <p-progressSpinner></p-progressSpinner>
      <p>Đang tải...</p>
    </div>
  }

  <form
    [formGroup]="purchaseForm"
    (ngSubmit)="onSubmit()"
    class="purchase-form"
    *ngIf="!loading"
  >
    <div class="form-grid">
      <!-- Purchase Date -->
      <div class="field">
        <label for="purchaseDate">Ngày nhập <span class="required">*</span></label>
        <p-datePicker
          inputId="purchaseDate"
          formControlName="purchaseDate"
          dateFormat="dd/mm/yy"
          [showIcon]="true"
          [class.ng-invalid]="isFieldInvalid('purchaseDate')"
          [class.ng-dirty]="isFieldInvalid('purchaseDate')"
          class="w-full"
        >
        </p-datePicker>
      </div>

      <!-- Provider -->
      <div class="field">
        <label for="providerId">Nhà cung cấp <span class="required">*</span></label>
        <p-select
          inputId="providerId"
          [options]="providers"
          formControlName="providerId"
          optionLabel="name"
          optionValue="id"
          placeholder="Chọn nhà cung cấp"
          [class.ng-invalid]="isFieldInvalid('providerId')"
          [class.ng-dirty]="isFieldInvalid('providerId')"
          class="w-full"
          [filter]="true"
        >
        </p-select>
      </div>

      <!-- Status -->
      <div class="field">
        <label for="status">Trạng thái <span class="required">*</span></label>
        <p-select
          inputId="status"
          [options]="statusOptions"
          formControlName="status"
          optionLabel="label"
          optionValue="value"
          placeholder="Chọn trạng thái"
          class="w-full"
        >
        </p-select>
      </div>

      <!-- Note -->
      <div class="field full-width">
        <label for="note">Ghi chú</label>
        <textarea
          id="note"
          pInputTextarea
          formControlName="note"
          rows="2"
          class="w-full"
        ></textarea>
      </div>
    </div>

    <!-- Purchase Items -->
    <div class="items-section">
      <div class="section-header">
        <h3>Danh sách sản phẩm</h3>
        <p-button
          type="button"
          label="Thêm sản phẩm"
          icon="pi pi-plus"
          (onClick)="addItem()"
        ></p-button>
      </div>

      <div formArrayName="items" class="items-table">
        <p-table [value]="items.controls" [tableStyle]="{ 'min-width': '60rem' }">
          <ng-template pTemplate="header">
            <tr>
              <th style="width: 35%">Sản phẩm <span class="required">*</span></th>
              <th style="width: 10%">SL <span class="required">*</span></th>
              <th style="width: 18%">Giá nhập <span class="required">*</span></th>
              <th style="width: 18%">Chiết khấu</th>
              <th style="width: 18%">Thành tiền</th>
              <th style="width: 60px"></th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-item let-i="rowIndex">
            <tr [formGroupName]="i">
              <td>
                <app-product-autocomplete
                  formControlName="productId"
                  (productSelected)="onProductSelectedForItem(i, $event)"
                  placeholder="Tìm sản phẩm..."
                  styleClass="w-full"
                >
                </app-product-autocomplete>
              </td>
              <td>
                <p-inputNumber
                  formControlName="quantity"
                  [min]="1"
                  [max]="999"
                  [showButtons]="true"
                  buttonLayout="horizontal"
                  decrementButtonClass="p-button-sm"
                  incrementButtonClass="p-button-sm"
                  incrementButtonIcon="pi pi-plus"
                  decrementButtonIcon="pi pi-minus"
                  class="w-full quantity-input"
                >
                </p-inputNumber>
              </td>
              <td>
                <p-inputNumber
                  formControlName="purchasePrice"
                  mode="currency"
                  currency="VND"
                  locale="vi-VN"
                  [minFractionDigits]="0"
                  class="w-full"
                >
                </p-inputNumber>
              </td>
              <td>
                <p-inputNumber
                  formControlName="discount"
                  mode="currency"
                  currency="VND"
                  locale="vi-VN"
                  [minFractionDigits]="0"
                  class="w-full"
                >
                </p-inputNumber>
              </td>
              <td>
                <input
                  type="text"
                  pInputText
                  [value]="formatCurrency(getItemTotal(i))"
                  readonly
                  class="w-full"
                />
              </td>
              <td class="text-center action-cell">
                <p-button
                  type="button"
                  icon="pi pi-comment"
                  [severity]="showNoteForItem[i] ? 'info' : 'secondary'"
                  [text]="true"
                  (onClick)="toggleNoteForItem(i)"
                  pTooltip="Ghi chú"
                  [class.active]="showNoteForItem[i]"
                ></p-button>
                <p-button
                  type="button"
                  icon="pi pi-trash"
                  severity="danger"
                  [text]="true"
                  (onClick)="removeItem(i)"
                  pTooltip="Xóa"
                ></p-button>
              </td>
            </tr>
            @if (showNoteForItem[i]) {
              <tr [formGroupName]="i">
                <td colspan="6" class="note-row">
                  <textarea
                    pInputTextarea
                    formControlName="note"
                    placeholder="Ghi chú cho sản phẩm này..."
                    rows="2"
                    class="w-full"
                  ></textarea>
                </td>
              </tr>
            }
          </ng-template>
          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="6" class="text-center">
                <div class="empty-message">
                  Chưa có sản phẩm nào. Nhấn "Thêm sản phẩm" để bắt đầu.
                </div>
              </td>
            </tr>
          </ng-template>
        </p-table>
      </div>

      <!-- Total Amount -->
      @if (items.length > 0) {
        <div class="total-section">
          <strong>Tổng tiền:</strong>
          <span class="total-amount">{{ formatCurrency(getTotalAmount()) }}</span>
        </div>
      }
    </div>

    <div class="form-actions">
      <p-button
        label="Hủy"
        icon="pi pi-times"
        severity="secondary"
        (onClick)="onCancel()"
        [disabled]="loading"
      >
      </p-button>
      <p-button
        [label]="loading ? 'Đang lưu...' : isEditMode ? 'Cập nhật' : 'Tạo phiếu nhập'"
        icon="pi pi-check"
        type="submit"
        [disabled]="loading"
        [loading]="loading"
      >
      </p-button>
    </div>
  </form>
</p-card>
