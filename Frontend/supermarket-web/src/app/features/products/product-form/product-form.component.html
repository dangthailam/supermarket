<p-card>
  <ng-template pTemplate="header">
    <div class="form-header">
      <h2>{{ isEditMode ? "Chỉnh sửa sản phẩm" : "Tạo sản phẩm mới" }}</h2>
    </div>
  </ng-template>

  @if (error) {
    <p-message severity="error" [text]="error" styleClass="mb-3"></p-message>
  }

  @if (loading) {
    <div class="loading-container">
      <p-progressSpinner></p-progressSpinner>
      <p>Đang tải...</p>
    </div>
  }

  <form
    [formGroup]="productForm"
    (ngSubmit)="onSubmit()"
    class="product-form"
    *ngIf="!loading"
  >
    <div class="form-grid">
      <!-- SKU -->
      <div class="field">
        <label for="sku">Mã sản phẩm</label>
        <input
          id="sku"
          type="text"
          pInputText
          formControlName="sku"
          readonly
          class="w-full"
        />
        <small class="form-hint">Tự động tạo</small>
      </div>

      <!-- Name -->
      <div class="field">
        <label for="name">Tên sản phẩm <span class="required">*</span></label>
        <input
          id="name"
          type="text"
          pInputText
          formControlName="name"
          [class.ng-invalid]="isFieldInvalid('name')"
          [class.ng-dirty]="isFieldInvalid('name')"
          class="w-full"
        />
        @if (isFieldInvalid("name")) {
          <small class="p-error">{{ getErrorMessage("name") }}</small>
        }
      </div>

      <!-- Barcodes -->
      <div class="field full-width">
        <label for="barcode">Mã vạch</label>
        <div class="barcode-input-group" style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
          <input
            id="barcode"
            type="text"
            pInputText
            [(ngModel)]="newBarcode"
            [ngModelOptions]="{standalone: true}"
            placeholder="Nhập mã vạch"
            class="flex-1"
            (keyup.enter)="addBarcode()"
          />
          <p-button
            type="button"
            icon="pi pi-plus"
            label="Thêm"
            (onClick)="addBarcode()"
          >
          </p-button>
        </div>
        
        @if (getBarcodes().length > 0) {
          <div class="barcode-list" style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
            @for (barcode of getBarcodes(); track barcode) {
              <div class="barcode-chip" style="display: flex; align-items: center; background: #e3f2fd; padding: 0.25rem 0.5rem; border-radius: 4px;">
                <span style="margin-right: 0.5rem;">{{ barcode }}</span>
                <button
                  type="button"
                  class="pi pi-times"
                  (click)="removeBarcode(barcode)"
                  style="background: none; border: none; cursor: pointer; color: #1976d2; padding: 0;"
                  title="Xóa mã vạch"
                >
                </button>
              </div>
            }
          </div>
        }
      </div>

      <!-- Category -->
      <div class="field">
        <label for="categoryId">Danh mục <span class="required">*</span></label>
        <p-select
          inputId="categoryId"
          [options]="categories"
          formControlName="categoryId"
          optionLabel="name"
          optionValue="id"
          placeholder="Chọn danh mục"
          [class.ng-invalid]="isFieldInvalid('categoryId')"
          [class.ng-dirty]="isFieldInvalid('categoryId')"
          styleClass="w-full"
        >
        </p-select>
        @if (isFieldInvalid("categoryId")) {
          <small class="p-error">{{ getErrorMessage("categoryId") }}</small>
        }
      </div>

      <!-- Price -->
      <div class="field">
        <label for="price">Giá bán <span class="required">*</span></label>
        <p-inputNumber
          inputId="price"
          formControlName="price"
          mode="currency"
          currency="VND"
          locale="vi-VN"
          [minFractionDigits]="0"
          [class.ng-invalid]="isFieldInvalid('price')"
          [class.ng-dirty]="isFieldInvalid('price')"
          styleClass="w-full"
        >
        </p-inputNumber>
        @if (isFieldInvalid("price")) {
          <small class="p-error">{{ getErrorMessage("price") }}</small>
        }
      </div>

      <!-- Cost Price -->
      <div class="field">
        <label for="costPrice"
          >Giá vốn <span class="required">*</span></label
        >
        <p-inputNumber
          inputId="costPrice"
          formControlName="costPrice"
          mode="currency"
          currency="VND"
          locale="vi-VN"
          [minFractionDigits]="0"
          [class.ng-invalid]="isFieldInvalid('costPrice')"
          [class.ng-dirty]="isFieldInvalid('costPrice')"
          styleClass="w-full"
        >
        </p-inputNumber>
        @if (isFieldInvalid("costPrice")) {
          <small class="p-error">{{ getErrorMessage("costPrice") }}</small>
        }
      </div>

      <!-- Stock Quantity -->
      <div class="field">
        <label for="stockQuantity"
          >Số lượng tồn kho <span class="required">*</span></label
        >
        <p-inputNumber
          inputId="stockQuantity"
          formControlName="stockQuantity"
          [class.ng-invalid]="isFieldInvalid('stockQuantity')"
          [class.ng-dirty]="isFieldInvalid('stockQuantity')"
          styleClass="w-full"
        >
        </p-inputNumber>
        @if (isEditMode) {
          <small class="form-hint"
            >Tồn kho được quản lý qua phiếu nhập xuất</small
          >
        }
        @if (isFieldInvalid("stockQuantity")) {
          <small class="p-error">{{ getErrorMessage("stockQuantity") }}</small>
        }
      </div>

      <!-- Min Stock Level -->
      <div class="field">
        <label for="minStockLevel"
          >Tồn kho tối thiểu <span class="required">*</span></label
        >
        <p-inputNumber
          inputId="minStockLevel"
          formControlName="minStockLevel"
          [class.ng-invalid]="isFieldInvalid('minStockLevel')"
          [class.ng-dirty]="isFieldInvalid('minStockLevel')"
          styleClass="w-full"
        >
        </p-inputNumber>
        @if (isFieldInvalid("minStockLevel")) {
          <small class="p-error">{{ getErrorMessage("minStockLevel") }}</small>
        }
      </div>

      <!-- Description (full width) -->
      <div class="field full-width">
        <label for="description">Mô tả</label>
        <textarea
          id="description"
          pInputTextarea
          formControlName="description"
          rows="3"
          class="w-full"
        ></textarea>
      </div>

      <!-- Product Image Upload -->
      <div class="field full-width">
        <label>Hình ảnh sản phẩm</label>
        
        @if (productForm.get('imageUrl')?.value) {
          <div class="image-preview-container" style="margin-bottom: 1rem;">
            <img 
              [src]="productForm.get('imageUrl')?.value" 
              alt="Hình sản phẩm"
              style="max-width: 300px; max-height: 300px; object-fit: contain; border: 1px solid #ddd; border-radius: 4px; padding: 8px;"
            />
            <p-button
              type="button"
              icon="pi pi-trash"
              label="Xóa ảnh"
              severity="danger"
              [text]="true"
              (onClick)="removeUploadedFile(null)"
              [style]="{ 'display': 'block', 'margin-top': '0.5rem' }"
            >
            </p-button>
          </div>
        }
        
        <p-fileUpload
          [multiple]="false"
          accept="image/*"
          [maxFileSize]="5000000"
          [showUploadButton]="false"
          [showCancelButton]="false"
          (onSelect)="onImageSelect($event)"
          (uploadHandler)="onImageUpload($event)"
          (onError)="onImageUploadError($event)"
          chooseLabel="Chọn ảnh hoặc chụp ảnh"
          [auto]="true"
          [customUpload]="true"
        >
          <ng-template pTemplate="content">
            @if (uploadedFiles.length) {
              <ul>
                <li
                  *ngFor="let file of uploadedFiles"
                  class="flex items-center justify-content-between"
                >
                  <div>
                    <span>{{ file.name }} - {{ file.size }} bytes</span>
                  </div>
                  <p-button
                    type="button"
                    icon="pi pi-times"
                    (onClick)="removeUploadedFile(file)"
                    [text]="true"
                    severity="danger"
                  >
                  </p-button>
                </li>
              </ul>
            }
          </ng-template>
        </p-fileUpload>
      </div>

      <!-- Is Active -->
      @if (isEditMode) {
        <div class="field field-checkbox">
          <p-checkbox
            inputId="isActive"
            formControlName="isActive"
            [binary]="true"
          >
          </p-checkbox>
          <label for="isActive">Đang hoạt động</label>
        </div>
      }
    </div>

    <div class="form-actions">
      <p-button
        label="Hủy"
        icon="pi pi-times"
        severity="secondary"
        (onClick)="onCancel()"
        [disabled]="loading"
      >
      </p-button>
      <p-button
        [label]="
          loading
            ? 'Đang lưu...'
            : isEditMode
              ? 'Cập nhật sản phẩm'
              : 'Tạo sản phẩm'
        "
        icon="pi pi-check"
        type="submit"
        [disabled]="loading"
        [loading]="loading"
      >
      </p-button>
    </div>
  </form>
</p-card>
