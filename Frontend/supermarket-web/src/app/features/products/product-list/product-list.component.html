<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>

<div class="p-3">
  <!-- Header -->
  <div class="flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
    <h2 class="m-0">Sản phẩm</h2>
    <div class="flex gap-2">
      <p-button 
        label="Danh mục" 
        icon="pi pi-tags" 
        severity="secondary" 
        (onClick)="manageCategories()"
        size="small"
      ></p-button>
      <p-button 
        label="Thêm sản phẩm" 
        icon="pi pi-plus" 
        (onClick)="addProduct()"
        size="small"
      ></p-button>
    </div>
  </div>

  <!-- Products Table -->
  <div class="overflow-auto">
    <p-table
      [value]="products"
      [loading]="loading"
        [paginator]="true"
        [rows]="pageSize"
        [totalRecords]="totalRecords"
        [lazy]="true"
        (onLazyLoad)="onLazyLoad($event)"
        [rowsPerPageOptions]="[10, 20, 50, 100]"
        [showCurrentPageReport]="true"
        currentPageReportTemplate="Hiển thị {first} đến {last} của {totalRecords} sản phẩm"
        styleClass="p-datatable-sm p-datatable-striped"
        [tableStyle]="{ 'min-width': '50rem' }"
      >
        <ng-template pTemplate="header">
          <tr>
            <th style="width: 3rem" class="text-center">
              <p-checkbox binary="true"></p-checkbox>
            </th>
            <th pSortableColumn="sku" style="width: 2rem"></th>
            <th pSortableColumn="sku" style="width: 5rem" class="p-2">
              Mã hàng
              <p-sortIcon field="sku"></p-sortIcon>
            </th>
            <th pSortableColumn="name" class="p-2">
              Tên hàng
              <p-sortIcon field="name"></p-sortIcon>
            </th>
            <th pSortableColumn="price" style="width: 10rem">
              Giá bán
              <p-sortIcon field="price"></p-sortIcon>
            </th>
            <th pSortableColumn="costPrice" style="width: 10rem">
              Giá vốn
              <p-sortIcon field="costPrice"></p-sortIcon>
            </th>
            <th pSortableColumn="stockQuantity" style="width: 8rem">
              Tồn kho
              <p-sortIcon field="stockQuantity"></p-sortIcon>
            </th>
            <th style="width: 8rem">Khách đặt</th>
            <th style="width: 10rem">Thời gian tạo</th>
            <th style="width: 10rem">Dự kiến hết hàng</th>
            <th style="width: 8rem">Thao tác</th>
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-product>
          <tr>
            <td class="text-center">
              <p-checkbox binary="true"></p-checkbox>
            </td>
            <td>
              <img
                [src]="product.imageUrl || 'assets/placeholder.svg'"
                [alt]=""
                width="32"
                class="shadow-2 border-round"
              />
            </td>
            <td class="p-2">
              <span>{{ product.sku }}</span>
            </td>
            <td class="p-2">
              {{ product.name }}
            </td>
            <td>
              <span class="text-primary"
                >{{ product.price | number : "1.0-0" }} đ</span
              >
            </td>
            <td>{{ product.costPrice | number : "1.0-0" }} đ</td>
            <td>
              <span
                [class]="
                  product.stockQuantity! <= 10 ? 'text-red-500 font-bold' : ''
                "
              >
                {{ product.stockQuantity }}
              </span>
            </td>
            <td>---</td>
            <td>---</td>
            <td>---</td>
            <td>
              <div class="flex gap-2">
                <button
                  pButton
                  type="button"
                  icon="pi pi-pencil"
                  class="p-button-rounded p-button-text p-button-sm"
                  (click)="editProduct(product.id!)"
                  pTooltip="Chỉnh sửa"
                ></button>
                <button
                  pButton
                  type="button"
                  icon="pi pi-trash"
                  class="p-button-rounded p-button-text p-button-danger p-button-sm"
                  (click)="deleteProduct(product)"
                  pTooltip="Xóa"
                ></button>
              </div>
            </td>
          </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="11" class="text-center">
              <div class="p-4">
                <i
                  class="pi pi-inbox"
                  style="font-size: 3rem; color: var(--surface-400)"
                ></i>
                <p class="mt-3 text-surface-500">Không tìm thấy sản phẩm nào</p>
              </div>
            </td>
          </tr>
        </ng-template>

        <ng-template pTemplate="loadingbody">
          <tr>
            <td colspan="11">
              <div class="flex align-items-center justify-content-center p-4">
                <i class="pi pi-spin pi-spinner" style="font-size: 2rem"></i>
                <span class="ml-2">Đang tải dữ liệu...</span>
              </div>
            </td>
          </tr>
        </ng-template>

        <ng-template pTemplate="summary">
          <div class="flex align-items-center justify-content-between">
            <span
              >Tổng giá trị tồn kho:
              <strong>{{
                getTotalValue() | currency : "VND" : "symbol" : "1.0-0"
              }}</strong></span
            >
            <span
              >Tổng số sản phẩm: <strong>{{ totalRecords }}</strong></span
            >
          </div>
        </ng-template>
      </p-table>
    </div>
</div>

<p-dialog 
  [(visible)]="showCategoryDialog" 
  [header]="'Quản lý danh mục'" 
  [modal]="true"
  [style]="{width: '90vw', maxWidth: '600px'}"
  [draggable]="false"
  [resizable]="false"
>
  <div class="mb-3">
    <div class="flex gap-2">
      <input 
        pInputText 
        [(ngModel)]="newCategoryName" 
        placeholder="Tên danh mục mới"
        class="flex-1"
        (keyup.enter)="createCategory()"
      />
      <p-button 
        label="Thêm" 
        icon="pi pi-plus" 
        (onClick)="createCategory()"
        [disabled]="!newCategoryName"
      ></p-button>
    </div>
  </div>

  <p-table [value]="categories" [paginator]="true" [rows]="5">
    <ng-template pTemplate="header">
      <tr>
        <th>Tên danh mục</th>
        <th style="width: 100px">Thao tác</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-category>
      <tr>
        <td>{{ category.name }}</td>
        <td>
          <div class="flex gap-1">
            <p-button 
              icon="pi pi-pencil" 
              [text]="true"
              size="small"
              (onClick)="editCategory(category)"
            ></p-button>
            <p-button 
              icon="pi pi-trash" 
              severity="danger"
              [text]="true"
              size="small"
              (onClick)="deleteCategory(category)"
            ></p-button>
          </div>
        </td>
      </tr>
    </ng-template>
    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="2" class="text-center">Chưa có danh mục nào</td>
      </tr>
    </ng-template>
  </p-table>
</p-dialog>
